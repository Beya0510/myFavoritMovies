@page "/managefavorites"
@using Favies.Models;
@inject AuthService AuthService
@inject GetMoviesService GetMoviesService
@inject NavigationManager NavigationManager

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>🔍 Rechercher un Film</h3>
</div>

<!-- Formulaire de recherche -->
<input type="text" @bind="SearchQuery" placeholder="Entrez un titre de film..." />
<button @onclick="SearchMovies">Rechercher</button>
<br/><br/>
@if (IsLoading)
{
    <p>Chargement des résultats...</p>
}
else if (MovieData is not null && MovieData.Any())
{
    <div>
        <h4>🎬 Résultats de la recherche</h4>
        <table class="movie-table">
            <thead>
            <tr>
                <th>Titre</th>
                <th>Année</th>
                <th>IMDb ID</th>
                <th>Favoris</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var movie in MovieData)
            {
                <tr>
                    <td>@movie.Title</td>
                    <td>@movie.Year</td>
                    <td>@movie.imdbID</td>
                    <td>
                        @if (currentUser is not null)
                        {
                            @if (!favorites.Any(m => m.imdbID == movie.imdbID))
                            {
                                <button @onclick="() => AddFavorite(movie)">⭐ Ajouter aux Favoris</button>
                            }
                            else
                            {
                                <button disabled>✅ Déjà en Favoris</button>
                            }
                        }
                        else
                        {
                            <p><i>Connectez-vous pour ajouter aux favoris.</i></p>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    <br/>

    <!-- Pagination -->
    <div>
        @if (CurrentPage > 1)
        {
            <button @onclick="PreviousPage">⬅ Précédent</button>
        }

        <span>Page @CurrentPage</span>

        @if (MovieData.Count() == MoviesPerPage)
        {
            <button @onclick="NextPage">Suivant ➡</button>
        }
    </div>
    <div>
        <span>Page @TotalPage</span>
    </div>
}
else
{
    <p>Aucun film trouvé.</p>
}
<br/>

<div class="d-flex justify-content-between align-items-center">
    <h3>Gérer mes favoris</h3>
</div>

@if (currentUser is null)
{
    <p>Veuillez vous connecter pour voir et gérer vos favoris.</p>
}
else
{
    <div class="favorites-container">
        <h4>Vos favoris</h4>

        @if (favorites.Any())
        {
            <table class="movie-table">
                <thead>
                <tr>
                    <th>Titre</th>
                    <th>Année</th>
                    <th>IMDb ID</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var movie in favorites)
                {
                    <tr>
                        <td>@movie.Title</td>
                        <td>@movie.Year</td>
                        <td>@movie.imdbID</td>
                        <td>
                            <button @onclick="() => EditFavorite(movie)" class="btn btn-primary btn-sm">Modifier</button>
                            <button @onclick="() => RemoveFavorite(movie)" class="btn btn-danger btn-sm">Retirer</button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
        else
        {
            <p>Vous n'avez aucun favori.</p>
        }
    </div>

    @if (IsEditing && SelectedFavorite is not null)
    {
        <div class="edit-form">
            <h4>Modifier le favori</h4>
            <label>Titre :</label>
            <input type="text" @bind="SelectedFavorite.Title" />
            <label>Année :</label>
            <input type="text" @bind="SelectedFavorite.Year" />
            <br />
            <button @onclick="SaveFavorite" class="btn btn-success btn-sm">Enregistrer</button>
            <button @onclick="CancelEdit" class="btn btn-secondary btn-sm">Annuler</button>
        </div>
    }
}

<!-- Message de succès ou d'erreur -->
@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info">
        @message
    </div>
}

@code {
    public string SearchQuery = "Inception"; // Valeur par défaut
    public bool IsLoading;
    public int CurrentPage = 1;
    public const int MoviesPerPage = 10;
    public User? currentUser;
    public IEnumerable<Movie> MovieData { get; set; } = new List<Movie>();
    public object TotalPage { get; set; }

    private List<Movie> favorites = new List<Movie>();
    private string message = ""; // Message de succès ou d'erreur
    private bool IsEditing = false;
    private Movie? SelectedFavorite;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();

        if (currentUser is not null)
        {
            favorites = await AuthService.GetFavoritesAsync(currentUser);
        }

        await SearchMovies();
    }

    public async Task SearchMovies()
    {
        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            IsLoading = true;
            MovieData = await GetMoviesService.SearchMoviesAsync(SearchQuery, CurrentPage);
            IsLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            await SearchMovies();
        }
    }

    private async Task NextPage()
    {
        CurrentPage++;
        await SearchMovies();
    }

    private async Task AddFavorite(Movie movie)
    {
        if (movie != null)
        {
            favorites.Add(movie);

            if (currentUser is not null)
            {
                await AuthService.SaveFavoritesAsync(currentUser, favorites);
            }
        }
    }

    private async Task RemoveFavorite(Movie movie)
    {
        favorites.Remove(movie);

        if (currentUser is not null)
        {
            await AuthService.SaveFavoritesAsync(currentUser, favorites);
        }
    }

    private void EditFavorite(Movie movie)
    {
        SelectedFavorite = new Movie
        {
            Title = movie.Title,
            Year = movie.Year,
            imdbID = movie.imdbID
        };
        IsEditing = true;
    }

    private async Task SaveFavorite()
    {
        if (SelectedFavorite != null)
        {
            var favorite = favorites.FirstOrDefault(m => m.imdbID == SelectedFavorite.imdbID);
            if (favorite != null)
            {
                favorite.Title = SelectedFavorite.Title;
                favorite.Year = SelectedFavorite.Year;

                if (currentUser is not null)
                {
                    await AuthService.SaveFavoritesAsync(currentUser, favorites);
                }
            }
        }
        IsEditing = false;
        SelectedFavorite = null;
    }

    private void CancelEdit()
    {
        IsEditing = false;
        SelectedFavorite = null;
    }
}