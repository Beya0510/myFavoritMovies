@page "/managefavorites"
@using Favies.Models;
@inject AuthService AuthService
@inject GetMoviesService GetMoviesService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>🔍 Rechercher un Film</h3>
</div>
<br/>

<!-- Formulaire de recherche -->
<input type="text" @bind="SearchQuery" placeholder="Entrez un titre de film..." />
<button @onclick="SearchMovies">Rechercher</button>

@if (IsLoading)
{
    <p>Chargement des résultats...</p>
}
else if (MovieData is not null && MovieData.Any())
{
    <div>
        <h4>🎬 Résultats de la recherche</h4>
        <table class="movie-table">
            <thead>
            <tr>
                <th>Titre</th>
                <th>Année</th>
                <th>IMDb ID</th>
                <th>Favoris</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var movie in MovieData)
            {
                <tr>
                    <td>@movie.Title</td>
                    <td>@movie.Year</td>
                    <td>@movie.imdbID</td>
                    <td>
                        @if (currentUser is not null)
                        {
                            @if (!favorites.Any(m => m.Title == movie.Title))
                            {
                                <button @onclick="() => AddFavorite(movie)">⭐ Ajouter aux Favoris</button>
                            }
                            else
                            {
                                <button disabled>✅ Déjà en Favoris</button>
                            }
                        }
                        else
                        {
                            <p><i>Connectez-vous pour ajouter aux favoris.</i></p>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    <br/>

    <!-- Pagination -->
    <div>
        @if (CurrentPage > 1)
        {
            <button @onclick="PreviousPage">⬅ Précédent</button>
        }

        <span>Page @CurrentPage</span>

        @if (MovieData.Count() == MoviesPerPage)
        {
            <button @onclick="NextPage">Suivant ➡</button>
        }
    </div>
}
else
{
    <p>Aucun film trouvé.</p>
}
<br/>

<div class="d-flex justify-content-between align-items-center">
    <h3>Gérer mes favoris</h3>
</div>

@if (currentUser is null)
{
    <p>Veuillez vous connecter pour voir et gérer vos favoris.</p>
}
else
{
    <div class="favorites-container">
        <h4>Vos favoris</h4>

        @if (favorites.Any())
        {
            <table class="movie-table">
                <thead>
                <tr>
                    <th>Titre</th>
                    <th>Année</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var movie in favorites)
                {
                    <tr>
                        <td>@movie.Title</td>
                        <td>@movie.Year</td>
                        <td>
                            <button @onclick="() => RemoveFavorite(movie)" class="btn btn-danger btn-sm">Retirer</button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
        else
        {
            <p>Vous n'avez aucun favori.</p>
        }
    </div>
}

<div class="admin-actions">
    <h4>Actions administratives</h4>

    <!-- Supprimer tous les utilisateurs -->
    <button @onclick="ConfirmDeleteAllUsers" class="btn btn-danger">Supprimer tous les utilisateurs</button>
    <br/>
    <br/>

    <!-- Supprimer un utilisateur spécifique -->
    <input type="text" @bind="emailToDelete" placeholder="Email de l'utilisateur à supprimer" />
    <button @onclick="DeleteUser" class="btn btn-warning">Supprimer un utilisateur</button>
</div>

<!-- Message de succès ou d'erreur -->
@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info">
        @message
    </div>
}

@code {
    public string SearchQuery = "Inception"; // Valeur par défaut
    public bool IsLoading;
    public int CurrentPage = 1;
    public const int MoviesPerPage = 10;
    public User? currentUser;
    public IEnumerable<Movie> MovieData { get; set; } = new List<Movie>();

    private List<Movie> favorites = new List<Movie>();
    private string emailToDelete = "";
    private string message = ""; // Message de succès ou d'erreur

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();

        if (currentUser is not null)
        {
            favorites = await AuthService.GetFavoritesAsync(currentUser);
        }

        await SearchMovies();
    }

    public async Task SearchMovies()
    {
        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            IsLoading = true;
            MovieData = await GetMoviesService.SearchMoviesAsync(SearchQuery, CurrentPage);
            IsLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            await SearchMovies();
        }
    }

    private async Task NextPage()
    {
        CurrentPage++;
        await SearchMovies();
    }

    private async Task AddFavorite(Movie movie)
    {
        if (movie != null)
        {
            favorites.Add(movie);

            if (currentUser is not null)
            {
                await AuthService.SaveFavoritesAsync(currentUser, favorites);
            }
        }
    }

    private async Task RemoveFavorite(Movie movie)
    {
        favorites.Remove(movie);

        if (currentUser is not null)
        {
            await AuthService.SaveFavoritesAsync(currentUser, favorites);
        }
    }

    // Confirmer avant de supprimer tous les utilisateurs
    private async Task ConfirmDeleteAllUsers()
    {
        var confirmResult = await JSRuntime.InvokeAsync<bool>("confirm", "Êtes-vous sûr de vouloir supprimer tous les utilisateurs ?");
        if (confirmResult)
        {
            await DeleteAllUsers();
        }
    }

    // Supprimer tous les utilisateurs
    private async Task DeleteAllUsers()
    {
        await AuthService.DeleteAllUsersAsync();
        message = "Tous les utilisateurs ont été supprimés avec succès.";
        StateHasChanged(); // Mise à jour de l'interface utilisateur
    }

    // Supprimer un utilisateur spécifique
    private async Task DeleteUser()
    {
        if (!string.IsNullOrEmpty(emailToDelete))
        {
            await AuthService.DeleteUserAsync(emailToDelete);
            message = $"L'utilisateur avec l'email {emailToDelete} a été supprimé avec succès.";
            emailToDelete = ""; // Réinitialiser le champ après suppression
            StateHasChanged(); // Mise à jour de l'interface utilisateur
        }
        else
        {
            message = "Veuillez entrer un email valide.";
            StateHasChanged(); // Mise à jour de l'interface utilisateur
        }
    }
}
